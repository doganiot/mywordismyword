{% extends 'base.html' %}
{% load static %}

{% block title %}Yeni Sözleşme Oluştur - sözümSöz{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus me-2"></i>
                        Yeni Sözleşme Oluştur
                    </h4>
                </div>

                <div class="card-body p-4">
                    <form method="post" id="contractForm">
                        {% csrf_token %}

                        <!-- Sözleşme Başlığı -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">
                                <i class="fas fa-heading me-1"></i>
                                Sözleşme Başlığı *
                            </label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title"
                                   placeholder="Örn: Cumartesi Buluşma Sözleşmesi" required maxlength="200">
                            <div class="form-text">
                                Sözleşmenizin kısa ve açıklayıcı bir başlığı olmalı.
                            </div>
                        </div>

                        <!-- Şablon Seçimi -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-magic me-1"></i>
                                Hazır Şablon Kullan (İsteğe Bağlı)
                            </label>
                            <div class="row g-3">
                                {% for template in templates %}
                                    <div class="col-md-6 col-lg-4">
                                        <div class="template-card border rounded p-3 h-100 template-option"
                                             data-template-id="{{ template.id }}"
                                             data-template-content="{{ template.content }}">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio"
                                                       name="template" value="{{ template.id }}"
                                                       id="template{{ template.id }}">
                                                <label class="form-check-label fw-bold" for="template{{ template.id }}">
                                                    {{ template.title }}
                                                </label>
                                            </div>
                                            <p class="text-muted small mb-2 mt-2">{{ template.description }}</p>
                                            <span class="badge bg-primary">{{ template.get_template_type_display }}</span>
                                        </div>
                                    </div>
                                {% endfor %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="template-card border rounded p-3 h-100 template-option active"
                                         data-template-id=""
                                         data-template-content="">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio"
                                                   name="template" value="" id="templateNone" checked>
                                            <label class="form-check-label fw-bold" for="templateNone">
                                                Boş Şablon
                                            </label>
                                        </div>
                                        <p class="text-muted small mb-2 mt-2">Kendi sözleşme içeriğinizi yazın.</p>
                                        <span class="badge bg-secondary">Özel</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sözleşme İçeriği -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">
                                <i class="fas fa-file-alt me-1"></i>
                                Sözleşme İçeriği *
                            </label>
                            <textarea class="form-control" id="content" name="content" rows="20"
                                      placeholder="Sözleşmenizin detaylarını buraya yazın..." required></textarea>
                            <div class="form-text">
                                Sözleşmenizin tüm maddelerini ve koşullarını açıkça belirtin.
                            </div>
                        </div>

                        <!-- Taraflar -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-users me-1"></i>
                                Sözleşme Tarafları
                            </label>

                            <!-- 1. Taraf (Kendi Adınız) -->
                            <div class="mb-3">
                                <label class="form-label text-muted">1. Taraf (Siz)</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    <input type="text" class="form-control" value="{{ user.get_full_name|default:user.username }}" readonly>
                                    <span class="input-group-text">
                                        <i class="fas fa-check text-success"></i>
                                    </span>
                                </div>
                                <small class="form-text text-muted">
                                    Sözleşmeyi oluşturan kişi olarak otomatik olarak taraf olarak ekleneceksiniz.
                                </small>
                            </div>

                            <!-- 2. Taraf Seçimi -->
                            <div class="mb-3">
                                <label class="form-label text-muted">2. Taraf Seçimi</label>

                                <!-- Vicdan Sözleşmesi Seçeneği -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="contract_type" id="self_contract" value="self">
                                        <label class="form-check-label fw-bold" for="self_contract">
                                            <i class="fas fa-heart text-danger me-2"></i>
                                            Vicdan Sözleşmesi
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">
                                        Sadece kendinizi bağlayan kişisel sözleşme oluşturun. Tek imza ile tamamlanır ve sadece sizin sayfanızda görünür.
                                    </small>
                                </div>

                                <!-- Diğer Kullanıcı Seçimi -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="contract_type" id="other_party" value="other" checked>
                                        <label class="form-check-label fw-bold" for="other_party">
                                            <i class="fas fa-users me-2"></i>
                                            Diğer Kişi ile Sözleşme
                                        </label>
                                    </div>
                                    <div id="other_party_section" class="ms-4">
                                        <label for="second_party" class="form-label text-muted small">2. Taraf (İsteğe Bağlı)</label>
                                        <div class="position-relative">
                                            <input type="text" class="form-control" id="second_party_search"
                                                   placeholder="Kullanıcı ara... (isim veya e-posta)">
                                            <select class="form-select position-absolute" id="second_party" name="second_party"
                                                    style="top: 0; left: 0; opacity: 0; pointer-events: none;">
                                                <option value="">-- 2. Taraf Seçin (İsteğe Bağlı) --</option>
                                                {% for other_user in other_users %}
                                                    <option value="{{ other_user.id }}"
                                                            data-name="{{ other_user.get_full_name|default:other_user.username }}"
                                                            data-email="{{ other_user.email }}">
                                                        {{ other_user.get_full_name|default:other_user.username }} ({{ other_user.email }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div id="user_results" class="mt-2" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                                            <!-- Arama sonuçları buraya gelecek -->
                                        </div>
                                        <small class="form-text text-muted">
                                            Sözleşmenin diğer tarafını sistemdeki kullanıcılar arasından seçebilirsiniz.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sözleşme Zamanlaması -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar me-1"></i>
                                Sözleşme Zamanlaması
                            </label>

                            <!-- Başlangıç Tarihi -->
                            <div class="mb-3">
                                <label for="start_date" class="form-label">Başlangıç Tarihi *</label>
                                <input type="date" class="form-control" id="start_date" name="start_date" required>
                                <div class="form-text">
                                    Sözleşmenin yürürlüğe gireceği tarih.
                                </div>
                            </div>

                            <!-- Süre Seçenekleri -->
                            <div class="mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="is_indefinite" name="is_indefinite">
                                    <label class="form-check-label fw-bold" for="is_indefinite">
                                        Süresiz Sözleşme
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    İşaretlerseniz sözleşme süresi olmayacak, süresiz olarak geçerli kalacaktır.
                                </small>
                            </div>

                            <!-- Sözleşme Süresi -->
                            <div class="mb-3" id="duration_section">
                                <label for="duration_months" class="form-label">Sözleşme Süresi (Ay) *</label>
                                <select class="form-select" id="duration_months" name="duration_months">
                                    <option value="">-- Süre Seçin --</option>
                                    <option value="1">1 Ay</option>
                                    <option value="3">3 Ay</option>
                                    <option value="6">6 Ay</option>
                                    <option value="12">1 Yıl</option>
                                    <option value="24">2 Yıl</option>
                                    <option value="36">3 Yıl</option>
                                    <option value="60">5 Yıl</option>
                                    <option value="120">10 Yıl</option>
                                </select>
                                <div class="form-text">
                                    Sözleşmenin kaç ay süreceğini belirtin.
                                </div>
                            </div>
                        </div>

                        <!-- Görünürlük Ayarı -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-eye me-1"></i>
                                Görünürlük Ayarı
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="visibility-option border rounded p-3 text-center">
                                        <input type="radio" class="btn-check" name="visibility"
                                               id="private" value="private" checked>
                                        <label class="btn btn-outline-primary w-100" for="private">
                                            <i class="fas fa-lock fa-2x mb-2"></i>
                                            <br>
                                            <strong>Gizli</strong>
                                            <br>
                                            <small class="text-muted">Sadece taraflar görebilir</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="visibility-option border rounded p-3 text-center">
                                        <input type="radio" class="btn-check" name="visibility"
                                               id="public" value="public">
                                        <label class="btn btn-outline-success w-100" for="public">
                                            <i class="fas fa-globe fa-2x mb-2"></i>
                                            <br>
                                            <strong>Herkese Açık</strong>
                                            <br>
                                            <small class="text-muted">Herkes görebilir ve indirebilir</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bilgilendirme -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Bilgi:</strong> Sözleşmenizi oluşturduktan sonra tarafları ekleyebilir,
                            düzenleyebilir ve imza süreci başlatabilirsiniz. Sözleşme en az 3 onay aldıktan
                            sonra geçerli hale gelir.
                        </div>

                        <!-- Butonlar -->
                        <div class="d-flex gap-3 pt-3 border-top">
                            <button type="submit" class="btn btn-primary btn-lg flex-fill">
                                <i class="fas fa-save me-2"></i>
                                Sözleşmeyi Oluştur
                            </button>
                            <button type="button" class="btn btn-outline-info btn-lg" onclick="previewContract()">
                                <i class="fas fa-eye me-2"></i>
                                Önizleme
                            </button>
                            <a href="{% url 'contracts:home' %}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>
                                İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sözleşme Önizleme Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Sözleşme Önizleme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="border p-3 bg-light" style="white-space: pre-wrap; min-height: 300px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<style>
.template-card {
    transition: all 0.3s ease;
    cursor: pointer;
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
}

.template-card:hover {
    border-color: #0d6efd !important;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.25);
    transform: translateY(-2px);
}

.template-card.active {
    border-color: #0d6efd !important;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.25);
    background: linear-gradient(135deg, #f8f9fa, #ffffff);
}

.template-card .form-check-input:checked ~ .form-check-label {
    color: #0d6efd;
    font-weight: bold;
}

.visibility-option {
    transition: all 0.3s ease;
}

.visibility-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-check:checked + .btn {
    border-color: currentColor;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

#contractForm {
    position: relative;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

@media (max-width: 768px) {
    .d-flex.gap-3 {
        flex-direction: column;
    }

    .btn {
        margin-bottom: 0.5rem;
    }
}
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateOptions = document.querySelectorAll('.template-option');
    const contentTextarea = document.getElementById('content');
    const contractForm = document.getElementById('contractForm');

    // Sözleşme türü seçimi
    const contractTypeRadios = document.querySelectorAll('input[name="contract_type"]');
    const otherPartySection = document.getElementById('other_party_section');
    const secondPartySearch = document.getElementById('second_party_search');
    const secondPartySelect = document.getElementById('second_party');

    // Sözleşme süresi seçimi
    const isIndefiniteCheckbox = document.getElementById('is_indefinite');
    const durationSection = document.getElementById('duration_section');
    const durationSelect = document.getElementById('duration_months');

    // Süresiz sözleşme değiştiğinde
    isIndefiniteCheckbox.addEventListener('change', function() {
        if (this.checked) {
            // Süresiz sözleşme seçildi
            durationSection.style.display = 'none';
            durationSelect.required = false;
            durationSelect.value = '';
        } else {
            // Süreli sözleşme seçildi
            durationSection.style.display = 'block';
            durationSelect.required = true;
        }
    });

    // Sözleşme türü değiştiğinde
    contractTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'self') {
                // Vicdan sözleşmesi seçildi
                otherPartySection.style.display = 'none';
                secondPartySearch.value = '';
                secondPartySelect.value = '';
                // Görünürlük ayarını otomatik private yap
                document.getElementById('private').checked = true;
            } else {
                // Diğer kişi ile sözleşme seçildi
                otherPartySection.style.display = 'block';
            }
        });
    });

    // Kullanıcı arama özelliği
    const searchInput = document.getElementById('second_party_search');
    const userResults = document.getElementById('user_results');
    const selectElement = document.getElementById('second_party');
    const options = Array.from(selectElement.options);

    // Arama işlevi
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        userResults.innerHTML = '';

        if (query.length === 0) {
            userResults.style.display = 'none';
            return;
        }

        const filteredOptions = options.filter(option => {
            if (!option.value) return false; // Boş option'ı hariç tut

            const name = option.getAttribute('data-name') || '';
            const email = option.getAttribute('data-email') || '';
            return name.toLowerCase().includes(query) || email.toLowerCase().includes(query);
        });

        if (filteredOptions.length > 0) {
            filteredOptions.forEach(option => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-2 border-bottom cursor-pointer user-result';
                resultDiv.style.cursor = 'pointer';
                resultDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <strong>${option.getAttribute('data-name')}</strong><br>
                            <small class="text-muted">${option.getAttribute('data-email')}</small>
                        </div>
                        <i class="fas fa-check text-success" style="display: none;"></i>
                    </div>
                `;

                resultDiv.addEventListener('click', function() {
                    // Seçimi uygula
                    selectElement.value = option.value;
                    searchInput.value = `${option.getAttribute('data-name')} (${option.getAttribute('data-email')})`;

                    // Diğer seçimleri temizle
                    document.querySelectorAll('.user-result .fa-check').forEach(icon => {
                        icon.style.display = 'none';
                    });

                    // Bu seçimi işaretle
                    this.querySelector('.fa-check').style.display = 'inline';

                    // Sonuçları gizle
                    userResults.style.display = 'none';
                });

                resultDiv.addEventListener('mouseover', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });

                resultDiv.addEventListener('mouseout', function() {
                    this.style.backgroundColor = '';
                });

                userResults.appendChild(resultDiv);
            });

            userResults.style.display = 'block';
        } else {
            userResults.innerHTML = '<div class="p-2 text-muted">Kullanıcı bulunamadı</div>';
            userResults.style.display = 'block';
        }
    });

    // Arama alanına odaklanınca sonuçları göster
    searchInput.addEventListener('focus', function() {
        if (this.value.trim() && userResults.children.length > 0) {
            userResults.style.display = 'block';
        }
    });

    // Dışarı tıklandığında sonuçları gizle
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !userResults.contains(e.target)) {
            userResults.style.display = 'none';
        }
    });

    // Şablon seçimi
    templateOptions.forEach(option => {
        option.addEventListener('click', function() {
            // Aktif sınıfını kaldır
            templateOptions.forEach(opt => opt.classList.remove('active'));

            // Bu seçeneği aktif yap
            this.classList.add('active');

            // Radio button'ı işaretle
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;

            // İçeriği yükle
            const templateContent = this.dataset.templateContent;
            if (templateContent && contentTextarea.value === '') {
                contentTextarea.value = templateContent;
            }
        });
    });

    // Form validasyonu
    contractForm.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');

        // Loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';

        // Form geçerli mi kontrol et
        if (!this.checkValidity()) {
            e.preventDefault();
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Sözleşmeyi Oluştur';

            // Hata mesajları göster
            showValidationErrors(this);
            return false;
        }
    });

    // Gerçek zamanlı karakter sayısı
    contentTextarea.addEventListener('input', function() {
        const charCount = this.value.length;
        const maxChars = 10000; // Maksimum karakter sayısı

        // İleride karakter sayacı eklenebilir
    });
});

function previewContract() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;

    if (!title || !content) {
        alert('Lütfen sözleşme başlığı ve içeriğini doldurun.');
        return;
    }

    const previewContent = document.getElementById('previewContent');
    previewContent.innerHTML = `
        <h4>${title}</h4>
        <hr>
        <div style="white-space: pre-wrap;">${content}</div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

function showValidationErrors(form) {
    // Tüm hataları temizle
    form.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
        const feedback = el.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
    });

    // Yeni hataları göster
    const invalidFields = form.querySelectorAll(':invalid');
    invalidFields.forEach(field => {
        field.classList.add('is-invalid');

        if (!field.parentNode.querySelector('.invalid-feedback')) {
            const errorMsg = document.createElement('div');
            errorMsg.className = 'invalid-feedback';
            errorMsg.textContent = getFieldErrorMessage(field);
            field.parentNode.appendChild(errorMsg);
        }
    });
}

function getFieldErrorMessage(field) {
    if (field.validity.valueMissing) {
        return 'Bu alan zorunludur.';
    }
    if (field.validity.tooLong) {
        return `Maksimum ${field.maxLength} karakter olabilir.`;
    }
    return 'Geçersiz değer.';
}
</script>
{% endblock %}
{% endblock %}